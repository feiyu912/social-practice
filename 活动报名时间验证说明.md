# 学生活动报名时间验证说明

## 修复内容

已为学生报名活动功能添加了**时间范围验证**，确保学生只能在活动的有效时间段内报名。

## 验证规则

学生报名活动时，系统会进行以下检查（按顺序）：

### 1. 用户权限验证
- ✅ 必须已登录
- ✅ 必须是学生角色

### 2. 学生信息验证
- ✅ 学生信息必须存在

### 3. 活动状态验证
- ✅ 活动必须存在
- ✅ 活动状态必须为 `recruiting`（招募中）

### 4. **时间范围验证**（新增）
- ✅ **当前时间必须 >= 活动开始时间**
  - 如果早于开始时间，提示："活动还未开始，无法报名"
- ✅ **当前时间必须 <= 活动结束时间**
  - 如果晚于结束时间，提示："活动已结束，无法报名"

### 5. 重复报名验证
- ✅ 不能重复报名同一活动

## 修改的文件

### 1. StudentActivityController.java
**位置**：`src/main/java/com/ssm/controller/StudentActivityController.java`

**修改内容**：
```java
// 检查当前时间是否在活动时间范围内
java.util.Date now = new java.util.Date();
if (activity.getStartTime() != null && now.before(activity.getStartTime())) {
    result.put("success", false);
    result.put("message", "活动还未开始，无法报名");
    return result;
}
if (activity.getEndTime() != null && now.after(activity.getEndTime())) {
    result.put("success", false);
    result.put("message", "活动已结束，无法报名");
    return result;
}
```

### 2. StudentActivityServiceImpl.java
**位置**：`src/main/java/com/ssm/service/impl/StudentActivityServiceImpl.java`

**修改内容**：
```java
// 检查当前时间是否在活动时间范围内
Date now = new Date();
if (activity.getStartTime() != null && now.before(activity.getStartTime())) {
    return false; // 活动还未开始
}
if (activity.getEndTime() != null && now.after(activity.getEndTime())) {
    return false; // 活动已结束
}
```

## 测试场景

### 场景1：活动还未开始
**测试数据**：
- 活动开始时间：2026-01-01 08:00:00
- 活动结束时间：2026-01-15 18:00:00
- 当前时间：2025-12-13 22:00:00

**预期结果**：
- ❌ 报名失败
- 提示："活动还未开始，无法报名"

### 场景2：活动进行中（有效报名时间）
**测试数据**：
- 活动开始时间：2025-05-01 08:00:00
- 活动结束时间：2025-05-30 18:00:00
- 当前时间：2025-05-15 10:00:00

**预期结果**：
- ✅ 可以报名
- 提示："报名成功，请等待教师审核"

### 场景3：活动已结束
**测试数据**：
- 活动开始时间：2025-03-01 08:00:00
- 活动结束时间：2025-03-20 18:00:00
- 当前时间：2025-12-13 22:00:00

**预期结果**：
- ❌ 报名失败
- 提示："活动已结束，无法报名"

## 数据库测试数据

根据当前时间（2025-12-13），数据库中的活动时间范围：

| 活动ID | 活动名称 | 开始时间 | 结束时间 | 能否报名 | 原因 |
|--------|---------|---------|---------|---------|------|
| 1 | 暑期三下乡 | 2025-07-01 | 2025-07-15 | ❌ | 已结束 |
| 2 | 企业参观 | 2025-06-15 | 2025-06-15 | ❌ | 已结束 |
| 3 | 社区服务 | 2025-05-01 | 2025-05-30 | ❌ | 已结束 |
| 4 | 红色教育 | 2025-04-01 | 2025-04-03 | ❌ | 已结束 |
| 5 | 科技创新 | 2025-08-01 | 2025-08-31 | ❌ | 已结束 |
| 6 | 环保公益 | 2025-09-01 | 2025-09-15 | ❌ | 已结束 |
| 7 | 文化调研 | 2025-03-01 | 2025-03-20 | ❌ | 已结束 |
| 8 | 乡村振兴 | 2025-10-01 | 2025-10-20 | ❌ | 已结束 |
| 9 | 法律援助 | 2025-06-01 | 2025-06-30 | ❌ | 已结束 |

**注意**：所有测试数据的活动都已过期，建议添加新的活动进行测试。

## 测试建议

### 方式1：修改现有活动时间（推荐）

使用MySQL Workbench或命令行执行：

```sql
-- 创建一个未来的活动（还未开始）
UPDATE practice_activity 
SET start_time = '2026-01-01 08:00:00', 
    end_time = '2026-01-15 18:00:00',
    status = 'recruiting'
WHERE id = 1;

-- 创建一个当前正在进行的活动
UPDATE practice_activity 
SET start_time = DATE_SUB(NOW(), INTERVAL 5 DAY), 
    end_time = DATE_ADD(NOW(), INTERVAL 15 DAY),
    status = 'recruiting'
WHERE id = 2;

-- 保持一个已结束的活动
UPDATE practice_activity 
SET start_time = '2025-03-01 08:00:00', 
    end_time = '2025-03-20 18:00:00',
    status = 'finished'
WHERE id = 3;
```

### 方式2：添加新的测试活动

```sql
INSERT INTO practice_activity (title, activity_name, description, start_time, end_time, location, quota, current_count, status) 
VALUES 
('即将开始的活动', '未来活动测试', '测试未开始状态', '2026-01-01 08:00:00', '2026-01-15 18:00:00', '测试地点', 50, 0, 'recruiting'),
('正在进行的活动', '进行中活动测试', '测试进行中状态', DATE_SUB(NOW(), INTERVAL 2 DAY), DATE_ADD(NOW(), INTERVAL 10 DAY), '测试地点', 50, 0, 'recruiting'),
('已结束的活动', '已结束活动测试', '测试已结束状态', '2025-01-01 08:00:00', '2025-01-15 18:00:00', '测试地点', 50, 0, 'finished');
```

## 验证方法

1. **重启应用**：
   ```bash
   # 停止Tomcat
   # 重新部署
   # 启动Tomcat
   ```

2. **以学生身份登录**：
   - 用户名：student1
   - 密码：123456

3. **尝试报名不同时间段的活动**：
   - 点击"活动管理" -> "浏览活动"
   - 对不同时间状态的活动点击"报名"按钮
   - 观察系统提示信息

4. **预期行为**：
   - 未开始的活动：显示"活动还未开始，无法报名"
   - 进行中的活动：显示"报名成功，请等待教师审核"
   - 已结束的活动：显示"活动已结束，无法报名"

## 编译状态

✅ **编译成功** - 所有修改已通过 Maven 编译

```bash
mvn compile -q
# 无错误输出
```

## 相关API文档

**接口**：`POST /studentActivity/register`

**请求参数**：
- `activityId`: 活动ID（必填）

**响应示例**：

成功（在有效时间内）：
```json
{
  "success": true,
  "message": "报名成功，请等待教师审核"
}
```

失败（活动未开始）：
```json
{
  "success": false,
  "message": "活动还未开始，无法报名"
}
```

失败（活动已结束）：
```json
{
  "success": false,
  "message": "活动已结束，无法报名"
}
```

## 总结

通过此次修改：
1. ✅ 加强了活动报名的时间控制
2. ✅ 防止学生报名未开始或已结束的活动
3. ✅ 在Controller和Service两层都做了验证，确保数据安全
4. ✅ 提供了清晰的错误提示，提升用户体验
5. ✅ 符合实际业务场景的时间管理需求
